<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema QR Code - Las Tortillas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #DC2626;
        }
        .test-table {
            border: 2px solid #DC2626;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            background: #FEF2F2;
        }
        .btn {
            background: #DC2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #B91C1C;
        }
        .qr-result {
            margin-top: 15px;
            padding: 15px;
            background: #F0FDF4;
            border: 1px solid #22C55E;
            border-radius: 5px;
        }
        .error {
            background: #FEE2E2;
            border: 1px solid #EF4444;
            color: #DC2626;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #E0F2FE;
            border: 1px solid #0284C7;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåÆ Las Tortillas - Sistema QR Code</h1>
            <p>Teste do Sistema de QR Codes para Mesas</p>
        </div>

        <div class="status" id="status">
            Carregando sistema...
        </div>

        <div class="test-table">
            <h3>üè¢ Teste 1: Criar Mesa de Teste</h3>
            <p>Criar uma mesa de teste para verificar o sistema QR code</p>
            <button class="btn" onclick="createTestTable()">Criar Mesa Teste</button>
            <div id="createResult"></div>
        </div>

        <div class="test-table">
            <h3>üìä Teste 2: Listar Mesas Existentes</h3>
            <p>Verificar mesas j√° criadas no sistema</p>
            <button class="btn" onclick="listTables()">Listar Mesas</button>
            <div id="listResult"></div>
        </div>

        <div class="test-table">
            <h3>üî• Teste 3: Gerar QR Code</h3>
            <p>Gerar QR code para uma mesa espec√≠fica</p>
            <input type="number" id="tableId" placeholder="ID da mesa" min="1">
            <button class="btn" onclick="generateQRCode()">Gerar QR Code</button>
            <div id="qrResult"></div>
        </div>

        <div class="test-table">
            <h3>üì± Teste 4: Simular Escaneamento</h3>
            <p>Simular o que acontece quando cliente escaneia QR code</p>
            <input type="text" id="qrUrl" placeholder="URL do QR Code" style="width: 300px;">
            <button class="btn" onclick="simulateQRScan()">Simular Escaneamento</button>
            <div id="scanResult"></div>
        </div>

        <div class="test-table">
            <h3>üéØ Links R√°pidos de Teste</h3>
            <p>Acesso direto √†s funcionalidades do sistema</p>
            <button class="btn" onclick="window.open('/admin', '_blank')">Painel Admin</button>
            <button class="btn" onclick="window.open('/menu?table=1&location=talatona&code=test123&t=1', '_blank')">Simular QR Mesa 1</button>
            <button class="btn" onclick="window.open('/menu?location=talatona', '_blank')">Menu Normal</button>
        </div>

        <div id="fullLog" style="margin-top: 20px; font-family: monospace; background: #f0f0f0; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto;"></div>
    </div>

    <script>
        let logDiv = document.getElementById('fullLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Verificar status inicial
        document.getElementById('status').innerHTML = '‚úÖ Sistema carregado - Pronto para testes';
        log('Sistema de teste QR code inicializado');

        async function createTestTable() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.innerHTML = 'Criando mesa de teste...';
            log('Iniciando cria√ß√£o de mesa de teste...');
            
            try {
                const response = await fetch('/api/tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tableNumber: Math.floor(Math.random() * 100) + 1,
                        locationId: 'talatona',
                        seats: 4,
                        status: 'available'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="qr-result">‚úÖ Mesa criada com sucesso! ID: ${data.id}, N√∫mero: ${data.tableNumber}</div>`;
                    log(`Mesa criada: ID ${data.id}, N√∫mero ${data.tableNumber}`, 'success');
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="qr-result error">‚ùå Erro: ${error.message}</div>`;
                log(`Erro ao criar mesa: ${error.message}`, 'error');
            }
        }

        async function listTables() {
            const resultDiv = document.getElementById('listResult');
            resultDiv.innerHTML = 'Carregando mesas...';
            log('Listando mesas existentes...');
            
            try {
                const response = await fetch('/api/tables');
                const tables = await response.json();
                
                if (response.ok) {
                    const tablesList = tables.map(table => 
                        `Mesa ${table.tableNumber} (ID: ${table.id}) - ${table.locationId} - ${table.seats} lugares - Status: ${table.status}`
                    ).join('<br>');
                    
                    resultDiv.innerHTML = `<div class="qr-result">üìã Mesas encontradas (${tables.length}):<br>${tablesList || 'Nenhuma mesa encontrada'}</div>`;
                    log(`${tables.length} mesas encontradas`, 'success');
                } else {
                    throw new Error('Erro ao carregar mesas');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="qr-result error">‚ùå Erro: ${error.message}</div>`;
                log(`Erro ao listar mesas: ${error.message}`, 'error');
            }
        }

        async function generateQRCode() {
            const tableId = document.getElementById('tableId').value;
            const resultDiv = document.getElementById('qrResult');
            
            if (!tableId) {
                resultDiv.innerHTML = '<div class="qr-result error">‚ùå Por favor, insira o ID da mesa</div>';
                return;
            }
            
            resultDiv.innerHTML = 'Gerando QR code...';
            log(`Gerando QR code para mesa ${tableId}...`);
            
            try {
                const response = await fetch(`/api/tables/${tableId}/qr-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="qr-result">
                            ‚úÖ QR Code gerado com sucesso!<br>
                            <strong>URL:</strong> <a href="${data.qrCodeUrl}" target="_blank">${data.qrCodeUrl}</a><br>
                            <strong>C√≥digo:</strong> ${data.qrCode}<br>
                            <img src="/api/tables/${tableId}/qr-code.svg" alt="QR Code" style="margin-top: 10px; max-width: 200px;">
                        </div>`;
                    log(`QR code gerado para mesa ${tableId}: ${data.qrCodeUrl}`, 'success');
                } else {
                    throw new Error(data.error || 'Erro desconhecido');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="qr-result error">‚ùå Erro: ${error.message}</div>`;
                log(`Erro ao gerar QR code: ${error.message}`, 'error');
            }
        }

        async function simulateQRScan() {
            const qrUrl = document.getElementById('qrUrl').value;
            const resultDiv = document.getElementById('scanResult');
            
            if (!qrUrl) {
                resultDiv.innerHTML = '<div class="qr-result error">‚ùå Por favor, insira uma URL de QR code</div>';
                return;
            }
            
            log(`Simulando escaneamento de QR: ${qrUrl}`);
            
            // Extrair par√¢metros da URL
            try {
                const url = new URL(qrUrl);
                const table = url.searchParams.get('table');
                const location = url.searchParams.get('location');
                const code = url.searchParams.get('code');
                const tableNumber = url.searchParams.get('t');
                
                resultDiv.innerHTML = `
                    <div class="qr-result">
                        üì± Escaneamento simulado:<br>
                        <strong>Mesa ID:</strong> ${table}<br>
                        <strong>N√∫mero da Mesa:</strong> ${tableNumber}<br>
                        <strong>Local:</strong> ${location}<br>
                        <strong>C√≥digo:</strong> ${code}<br>
                        <button class="btn" onclick="window.open('${qrUrl}', '_blank')">Abrir Menu da Mesa</button>
                    </div>`;
                log(`QR escaneado: Mesa ${tableNumber} (ID: ${table}) em ${location}`, 'success');
            } catch (error) {
                resultDiv.innerHTML = `<div class="qr-result error">‚ùå URL inv√°lida: ${error.message}</div>`;
                log(`URL inv√°lida: ${error.message}`, 'error');
            }
        }

        // Carregar mesas automaticamente ao iniciar
        setTimeout(listTables, 1000);
    </script>
</body>
</html>